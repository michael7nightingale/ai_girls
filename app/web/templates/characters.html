{% extends "base.html" %}

{% block title %}–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ - AI Girls{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-pink-600 mb-4">üé≠ –ù–∞—à–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é –∏–¥–µ–∞–ª—å–Ω—É—é —Å–ø—É—Ç–Ω–∏—Ü—É –¥–ª—è –∏–Ω—Ç–∏–º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è. –ö–∞–∂–¥—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä.
        </p>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="flex justify-center mb-8">
        <div class="bg-white rounded-lg shadow-md p-4 flex space-x-4">
            <button id="filter-all" class="filter-btn active px-4 py-2 rounded-lg bg-pink-500 text-white">
                –í—Å–µ
            </button>
            <button id="filter-free" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ
            </button>
            <button id="filter-premium" class="filter-btn px-4 py-2 rounded-lg bg-purple-200 text-purple-700 hover:bg-purple-300">
                –ü—Ä–µ–º–∏—É–º
            </button>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π -->
    <div id="characters-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for character in characters %}
        <div class="character-card bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 {{ 'premium' if character.is_premium else 'free' }}">
            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
            <div class="relative h-64 bg-gradient-to-br from-pink-100 to-purple-100">
                {% if character.image_url %}
                <img src="{{ character.image_url }}" alt="{{ character.name }}" 
                     class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full flex items-center justify-center">
                    <div class="text-6xl">{{ character.emoji or 'üëß' }}</div>
                </div>
                {% endif %}
                
                <!-- –ë–µ–π–¥–∂ –ø—Ä–µ–º–∏—É–º -->
                {% if character.is_premium %}
                <div class="absolute top-4 right-4">
                    <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                        üíé –ü—Ä–µ–º–∏—É–º
                    </span>
                </div>
                {% else %}
                <div class="absolute top-4 right-4">
                    <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                        üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ -->
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">{{ character.name }}</h3>
                <p class="text-gray-600 text-sm mb-4 line-clamp-3">{{ character.description }}</p>
                
                <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for tag in character.tags[:3] %}
                    <span class="bg-pink-100 text-pink-700 px-2 py-1 rounded-full text-xs">
                        {{ tag }}
                    </span>
                    {% endfor %}
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="flex justify-between text-sm text-gray-500 mb-4">
                    <span>üí¨ {{ character.chats_count or 0 }} —á–∞—Ç–æ–≤</span>
                    <span>‚≠ê {{ "%.1f"|format(character.rating or 4.5) }}</span>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="flex space-x-2">
                    <button onclick="startChat({{ character.id }})" 
                            class="flex-1 bg-gradient-to-r from-pink-500 to-purple-500 text-white py-2 px-4 rounded-lg hover:from-pink-600 hover:to-purple-600 transition-all duration-200 font-semibold">
                        üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç
                    </button>
                    <button onclick="viewProfile({{ character.id }})" 
                            class="bg-gray-200 text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if pagination.pages > 1 %}
    <div class="flex justify-center mt-12">
        <nav class="flex space-x-2">
            {% if pagination.has_prev %}
            <a href="?page={{ pagination.prev_num }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                ‚Üê –ù–∞–∑–∞–¥
            </a>
            {% endif %}
            
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    {% if page_num != pagination.page %}
                    <a href="?page={{ page_num }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        {{ page_num }}
                    </a>
                    {% else %}
                    <span class="px-4 py-2 bg-pink-500 text-white rounded-lg">
                        {{ page_num }}
                    </span>
                    {% endif %}
                {% else %}
                <span class="px-4 py-2">...</span>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <a href="?page={{ pagination.next_num }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                –í–ø–µ—Ä–µ–¥ ‚Üí
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
<div id="character-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">
                    √ó
                </button>
                <div id="modal-content">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFilter = 'all';

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const filter = this.id.replace('filter-', '');
        setActiveFilter(filter);
        filterCharacters(filter);
    });
});

function setActiveFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-pink-500', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    const activeBtn = document.getElementById(`filter-${filter}`);
    activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
    activeBtn.classList.add('active', 'bg-pink-500', 'text-white');
}

function filterCharacters(filter) {
    const cards = document.querySelectorAll('.character-card');
    cards.forEach(card => {
        if (filter === 'all') {
            card.style.display = 'block';
        } else if (filter === 'free' && card.classList.contains('free')) {
            card.style.display = 'block';
        } else if (filter === 'premium' && card.classList.contains('premium')) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// –ù–∞—á–∞—Ç—å —á–∞—Ç —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º
function startChat(characterId) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!isAuthenticated()) {
        showLoginModal();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø—Ä–µ–º–∏—É–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    const card = document.querySelector(`[onclick="startChat(${characterId})"]`).closest('.character-card');
    if (card.classList.contains('premium') && !hasPremium()) {
        showPremiumModal();
        return;
    }
    
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
    window.location.href = `/chat/${characterId}`;
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function viewProfile(characterId) {
    fetch(`/api/characters/${characterId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCharacterModal(data.character);
            } else {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
        });
}

function showCharacterModal(character) {
    const modal = document.getElementById('character-modal');
    const content = document.getElementById('modal-content');
    
    content.innerHTML = `
        <div class="p-6">
            <div class="flex items-center mb-6">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-100 to-purple-100 flex items-center justify-center text-3xl mr-4">
                    ${character.emoji || 'üëß'}
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">${character.name}</h2>
                    <p class="text-gray-600">${character.age || '18'} –ª–µ—Ç</p>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">–û –ø–µ—Ä—Å–æ–Ω–∞–∂–µ</h3>
                <p class="text-gray-700">${character.description}</p>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">–õ–∏—á–Ω–æ—Å—Ç—å</h3>
                <p class="text-gray-700">${character.personality}</p>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">–ò–Ω—Ç–µ—Ä–µ—Å—ã</h3>
                <div class="flex flex-wrap gap-2">
                    ${(character.tags || []).map(tag => 
                        `<span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-full text-sm">${tag}</span>`
                    ).join('')}
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    <div>üí¨ ${character.chats_count || 0} —á–∞—Ç–æ–≤</div>
                    <div>‚≠ê ${(character.rating || 4.5).toFixed(1)} —Ä–µ–π—Ç–∏–Ω–≥</div>
                </div>
                <button onclick="startChat(${character.id})" 
                        class="bg-gradient-to-r from-pink-500 to-purple-500 text-white py-3 px-6 rounded-lg hover:from-pink-600 hover:to-purple-600 transition-all duration-200 font-semibold">
                    üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç
                </button>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('character-modal').classList.add('hidden');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function isAuthenticated() {
    return localStorage.getItem('auth_token') !== null;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∏
function hasPremium() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    return user.role === 'premium';
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞
function showLoginModal() {
    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–º–∏—É–º–∞
function showPremiumModal() {
    window.location.href = '/premium';
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
function showError(message) {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
    alert(message);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
    const cards = document.querySelectorAll('.character-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}
