{% extends "base.html" %}

{% block title %}AI Girls - –ß–∞—Ç{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-user text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold" id="character-name">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
                        <p class="text-sm opacity-90" id="character-status">–ù–µ –≤ —Å–µ—Ç–∏</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition-colors" onclick="clearChat()">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition-colors" onclick="toggleCharacters()">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="h-96 overflow-y-auto p-4 bg-gray-50" id="chat-messages">
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-comments text-4xl mb-4"></i>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞</p>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π -->
        <div class="hidden bg-white border-t border-gray-200 p-4" id="characters-panel">
            <h3 class="text-lg font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="characters-list">
                <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div class="bg-white border-t border-gray-200 p-4">
            <div class="flex items-center space-x-2">
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        disabled
                    >
                </div>
                <button 
                    id="send-button" 
                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                    onclick="sendMessage()"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="mt-2 text-sm text-gray-500">
                <span id="message-limit">–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π: 0/10</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentCharacter = null;
let currentChatId = null;
let messages = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
async function loadCharacters() {
    try {
        const response = await fetch('/api/characters', {
            headers: {
                'Authorization': 'Bearer ' + getAuthToken()
            }
        });
        
        if (response.ok) {
            const characters = await response.json();
            displayCharacters(characters);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
function displayCharacters(characters) {
    const container = document.getElementById('characters-list');
    container.innerHTML = '';
    
    characters.forEach(character => {
        const card = document.createElement('div');
        card.className = 'character-card bg-gradient-to-br from-pink-100 to-purple-100 p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow';
        card.onclick = () => selectCharacter(character);
        
        card.innerHTML = `
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full mx-auto mb-3 flex items-center justify-center">
                    <i class="fas fa-user text-white text-xl"></i>
                </div>
                <h4 class="font-semibold text-gray-800">${character.name}</h4>
                <span class="text-xs ${character.is_premium ? 'text-purple-600' : 'text-green-600'} font-semibold">
                    ${character.is_premium ? 'üíé –ü—Ä–µ–º–∏—É–º' : 'üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}
                </span>
                <p class="text-gray-600 text-sm mt-2">${character.description.substring(0, 100)}...</p>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// –í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
async function selectCharacter(character) {
    try {
        const response = await fetch('/api/chats?character_id=' + character.id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getAuthToken()
            },
        });
        
        if (response.ok) {
            const result = await response.json();
            currentCharacter = character;
            currentChatId = result.chat_id;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-status').textContent = '–û–Ω–ª–∞–π–Ω';
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
            document.getElementById('characters-panel').classList.add('hidden');
            
            // –û—á–∏—â–∞–µ–º —á–∞—Ç
            clearChat();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–º–∏—Ç—ã
            loadUserProfile();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
async function loadMessages() {
    if (!currentChatId) return;
    
    try {
        const response = await fetch(`/api/chats/${currentChatId}/messages`, {
            headers: {
                'Authorization': 'Bearer ' + getAuthToken()
            }
        });
        
        if (response.ok) {
            messages = await response.json();
            displayMessages();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
function displayMessages() {
    const container = document.getElementById('chat-messages');
    container.innerHTML = '';
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-comments text-4xl mb-4"></i>
                <p>–ù–∞—á–Ω–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å ${currentCharacter.name}</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-bubble mb-4 ${message.is_user_message ? 'text-right' : 'text-left'}`;
        
        const bubbleClass = message.is_user_message 
            ? 'bg-purple-600 text-white' 
            : 'bg-white text-gray-800 border border-gray-200';
        
        messageDiv.innerHTML = `
            <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bubbleClass} shadow-sm">
                <p class="text-sm">${escapeHtml(message.content)}</p>
                <p class="text-xs opacity-70 mt-1">${formatTime(message.created_at)}</p>
            </div>
        `;
        
        container.appendChild(messageDiv);
    });
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    container.scrollTop = container.scrollHeight;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message || !currentChatId) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMessage = {
        content: message,
        is_user_message: true,
        created_at: new Date().toISOString()
    };
    
    messages.push(userMessage);
    displayMessages();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    input.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chat-bubble mb-4 text-left';
    loadingDiv.innerHTML = `
        <div class="inline-block bg-white text-gray-800 border border-gray-200 px-4 py-2 rounded-lg shadow-sm">
            <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600"></div>
                <span class="text-sm">–ü–µ—á–∞—Ç–∞–µ—Ç...</span>
            </div>
        </div>
    `;
    
    document.getElementById('chat-messages').appendChild(loadingDiv);
    document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    
    try {
        const response = await fetch(`/api/chats/${currentChatId}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getAuthToken()
            },
            body: JSON.stringify({ content: message })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingDiv.remove();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
            messages.push(result.ai_message);
            displayMessages();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç—ã
            loadUserProfile();
        } else {
            loadingDiv.remove();
            showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
    } catch (error) {
        loadingDiv.remove();
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserProfile() {
    try {
        const response = await fetch('/api/user/profile', {
            headers: {
                'Authorization': 'Bearer ' + getAuthToken()
            }
        });
        
        if (response.ok) {
            const profile = await response.json();
            const limit = profile.role === 'premium' ? 100 : 10;
            document.getElementById('message-limit').textContent = 
                `–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π: ${profile.messages_used_today}/${limit}`;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function clearChat() {
    messages = [];
    displayMessages();
}

function toggleCharacters() {
    const panel = document.getElementById('characters-panel');
    panel.classList.toggle('hidden');
}

function getAuthToken() {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ localStorage –∏–ª–∏ cookies
    return 'demo-token';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        errorDiv.remove();
    }, 3000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadCharacters();
});
</script>
{% endblock %}
